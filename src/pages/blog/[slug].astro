---
import LayoutWithoutTransitions from "../../components/LayoutWithoutTransitions.astro";
import { supabase, Post } from "../../utils/database";
import PasswordInput from "../../components/PasswordInput.astro";

const { slug } = Astro.params;

let post: Post | null = null;
let error: any = null;

if (supabase) {
  const { data, error: fetchError } = await supabase
    .from("posts")
    .select("*")
    .eq("slug", slug)
    .single();

  post = data;
  error = fetchError;

  // ✅ Increment view count
//   if (post) {
//     await supabase
//       .from("posts")
//       .update({ views: post.views + 1 })
//       .eq("slug", slug);
//   }
// } else {
//   error = new Error("Supabase client is not initialized");
}
---

<LayoutWithoutTransitions title={post ? post.title : "Post Not Found"}>
  {
    error || !post ? (
      <p class="text-red-500">
        Error loading post: {error?.message || "Not found"}
      </p>
    ) : (
      <article class="max-w-2xl mx-auto p-8 border border-gray-300 rounded-lg shadow">
        <h1 class="text-3xl font-bold mb-4">{post.title}</h1>
        {/* <a href="/blog" class="mb-4 inline-block hover:underline">← Back</a> */}
        <p class="text-sm text-gray-400">
          By {post.author} on {new Date(post.created_at).toLocaleDateString()} ·{" "}
          <span data-views>{post.views}</span> views ·{" "} {post.likes} likes
        </p>
        <div class="mt-4 flex gap-2">
              {post.tags.map(tag => (
                <span class="text-xs bg-gray-300 px-2 py-1 rounded">{tag}</span>
              ))}
            </div>

        <!-- Password protected content -->
        <div class="post-content hidden">
          <div class="prose prose-neutral mt-6" set:html={post.content} />

          <div class="flex items-center mt-4">
            <img
              id="like-button"
              class="w-5 h-5 cursor-pointer transition-opacity hover:opacity-80"
              src="/images/heart.svg"
              alt="Like"
              data-slug={post.slug}
              data-liked="false"
            />
            <span id="like-count" class="ml-1 text-md font-semibold">{post.likes}</span>
          </div>
        </div>

        <a href="/blog" class="mt-6 inline-block text-blue-500 hover:underline">
          ← Back to Blog
        </a>
      </article>
    )
  }
</LayoutWithoutTransitions>

<script>
  // Check if password is already stored
  const storedPassword = localStorage.getItem('blogPassword');
  const correctPassword = 'elliots#1fan';
  
  if (storedPassword === correctPassword) {
    // Show content if password is correct
    const content = document.querySelector('.post-content');
    if (content) {
      (content as HTMLElement).style.display = 'block';
    }
  } else {
    // Use the PasswordInput component
    const passwordInput = document.createElement('div');
    passwordInput.innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="m-2 bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
          <h2 class="text-2xl font-bold mb-4">Enter Password</h2>
          <p class="text-gray-600 mb-4">This post is password protected. Please enter the password to view the content.</p>
          <input
            type="password"
            id="password-input"
            class="w-full p-2 border border-gray-300 rounded mb-4"
            placeholder="Enter password"
          />
          <div class="flex gap-4">
            <a
              href="/blog"
              class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 transition-colors text-center"
            >
              ← Back to Blog
            </a>
            <button
              id="submit-password"
              class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors"
            >
              Submit
            </button>
          </div>
          <p id="error-message" class="text-red-500 mt-2 hidden">Incorrect password</p>
        </div>
      </div>
    `;
    document.body.appendChild(passwordInput);

    const passwordInputElement = document.getElementById('password-input');
    const submitButton = document.getElementById('submit-password');
    const errorMessage = document.getElementById('error-message');

    if (submitButton && passwordInputElement && errorMessage) {
      submitButton.addEventListener('click', () => {
        const enteredPassword = (passwordInputElement as HTMLInputElement).value;
        if (enteredPassword === correctPassword) {
          localStorage.setItem('blogPassword', enteredPassword);
          const overlay = document.querySelector('.fixed');
          if (overlay) {
            (overlay as HTMLElement).style.display = 'none';
          }
          const content = document.querySelector('.post-content');
          if (content) {
            (content as HTMLElement).style.display = 'block';
          }
        } else {
          errorMessage.classList.remove('hidden');
        }
      });

      passwordInputElement.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitButton.click();
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const slug = window.location.pathname.split('/').pop();
    const likeButton = document.getElementById("like-button");
    const likeCount = document.getElementById("like-count");
    
    // Handle views
    let viewedPosts = [];
    try {
      viewedPosts = JSON.parse(localStorage.getItem('viewedPosts') || '[]');
    } catch (e) {
      console.error('Error parsing viewed posts from localStorage', e);
      viewedPosts = [];
    }
    
    // Only increment views if this post hasn't been viewed before
    if (!viewedPosts.includes(slug)) {
      try {
        const response = await fetch("/api/view-post", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "X-Viewed-Posts": JSON.stringify(viewedPosts)
          },
          body: JSON.stringify({ slug })
        });
        
        const result = await response.json();
        if (result.success) {
          // Add this post to viewed posts in localStorage
          viewedPosts.push(slug);
          localStorage.setItem('viewedPosts', JSON.stringify(viewedPosts));
          
          // Update the view count in the UI if needed
          const viewCountElement = document.querySelector('[data-views]');
          if (viewCountElement) {
            viewCountElement.textContent = result.newViews;
          }
        }
      } catch (error) {
        console.error("Failed to record view:", error);
      }
    }

    // Handle likes (existing code)
    // Check localStorage for liked state
    if (localStorage.getItem(`liked_${slug}`)) {
      likeButton.src = "/images/heart-filled.svg";
      likeButton.dataset.liked = "true";
      likeButton.style.pointerEvents = "none"; // Prevent clicking after liking
    }

    likeButton.addEventListener("click", async () => {
      if (likeButton.dataset.liked === "true") return; // Prevent multiple likes

      try {
        const response = await fetch("/api/like-post", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ slug })
        });

        const result = await response.json();
        if (result.success) {
          likeCount.textContent = result.newLikes;
          likeButton.src = "/images/heart-filled.svg";
          likeButton.dataset.liked = "true";

          // Mark as liked in localStorage
          localStorage.setItem(`liked_${slug}`, "true");

          // Prevent further clicks
          likeButton.style.pointerEvents = "none";
        } else {
          console.error("Error:", result.error);
        }
      } catch (error) {
        console.error("Failed to like post:", error);
      }
    });
  });
</script>
