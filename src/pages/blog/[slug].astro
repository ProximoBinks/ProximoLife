---
import Layout from "../../components/Layout.astro";
import { supabase, Post } from "../../utils/database";

export async function getStaticPaths() {
  if (!supabase) return { paths: [], fallback: false };

  const { data, error } = await supabase.from("posts").select("slug");
  if (!data || error) return { paths: [], fallback: false };

  return {
    paths: data.map((row) => ({
      params: { slug: row.slug },
    })),
    fallback: false,
  };
}

const { slug } = Astro.params;

let post: Post | null = null;
let error: any = null;

if (supabase) {
  const { data, error: fetchError } = await supabase
    .from("posts")
    .select("*")
    .eq("slug", slug)
    .single();

  post = data;
  error = fetchError;
} else {
  error = new Error("Supabase client is not initialized");
}
---

<Layout title={post ? post.title : "Post Not Found"}>
  {error || !post ? (
    <p class="text-red-500">
      Error loading post: {error?.message || "Not found"}
    </p>
  ) : (
    <article class="max-w-2xl mx-auto p-8 border border-gray-300 rounded-lg shadow">
      <h1 class="text-3xl font-bold mb-4">{post.title}</h1>
      <p class="text-sm text-gray-400">
        By {post.author} on {new Date(post.created_at).toLocaleDateString()}
      </p>
      <!-- Render post.content as raw HTML here -->
      <div class="prose prose-neutral mt-6" set:html={post.content}></div>
      
      <a href="/blog" class="mt-6 inline-block text-blue-500 hover:underline">
        ‚Üê Back to Blog
      </a>
    </article>
  )}
</Layout>
