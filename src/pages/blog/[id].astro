---
import Layout from "../../components/Layout.astro";
import { supabase, Post } from "../../utils/database";

/** 1) Provide getStaticPaths() so Astro knows which IDs to build at compile time */
export async function getStaticPaths() {
  if (!supabase) {
    // If supabase is null, return empty paths so build doesn't fail
    return [];
  }

  // Fetch the full list of post IDs
  const { data, error } = await supabase.from("posts").select("id");
  if (!data || error) {
    // If there's an error or no data, return empty
    return [];
  }

  // Map each row to { params: { id: "the-uuid" } }
  const paths = data.map((row) => ({
    params: { id: row.id },
  }));

  return paths;
}

/** 2) Load a single post via SSR-like call at build time. */
const { id } = Astro.params;

let post: Post | null = null;
let error: any = null;

if (supabase) {
  const { data, error: fetchError } = await supabase
    .from("posts")
    .select("*")
    .eq("id", id)
    .single();

  post = data;
  error = fetchError;
} else {
  error = new Error("Supabase client is not initialized");
}
---

<Layout title={post ? post.title : "Post Not Found"}>
  {error || !post ? (
    <p class="text-red-500">
      Error loading post: {error?.message || "Not found"}
    </p>
  ) : (
    <article class="p-8 border rounded border-neutral-600">
      <h1 class="text-3xl font-bold mb-4">{post.title}</h1>
      <p class="text-sm text-gray-400">
        By {post.author} on {new Date(post.created_at).toLocaleDateString()}
      </p>
      <div class="prose prose-neutral mt-6">{post.content}</div>
    </article>
  )}
</Layout>
